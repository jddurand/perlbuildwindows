cmake_minimum_required (VERSION 3.6)
project (graphicsmagick)

find_package(JPEG REQUIRED)
find_package(LibLZMA REQUIRED)
find_package(PNG REQUIRED)
find_package(TIFF REQUIRED)
find_package(Freetype REQUIRED)
find_package(BZip2 REQUIRED)
find_package(WebP REQUIRED)
find_package(LibXml2 REQUIRED)
find_package(ZLIB REQUIRED)
find_package(zstd REQUIRED)

list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_LIST_DIR}/cmake")
find_package(JBIG REQUIRED)
find_package(JBIG85 REQUIRED)

include(FindPkgConfig)
pkg_check_modules(libheif REQUIRED IMPORTED_TARGET libheif)
pkg_check_modules(Jxl REQUIRED IMPORTED_TARGET libjxl)
pkg_check_modules(JxlThreads REQUIRED IMPORTED_TARGET libjxl_threads)
pkg_check_modules(Lcms2 REQUIRED IMPORTED_TARGET lcms2)

include(FindThreads)

add_definitions(-D_MAGICKLIB_ -D_WANDLIB_ -DMAGICK_IMPLEMENTATION)

if (BUILD_SHARED_LIBS)
    add_definitions(-D_DLL -DDLL)
endif ()

if (MSVC)
    add_definitions( -D_VISUALC_ -D_CRT_SECURE_NO_WARNINGS -D_CRT_SECURE_NO_DEPRECATE -D_CRT_NONSTDC_NO_DEPRECATE)
endif ()

if (WIN32)
    add_definitions(-DWIN32 -D_WIN32)
    add_definitions(-D_WIN32_WINNT=0x0501)
endif ()

include_directories(".")
include_directories("magick")
include_directories("Magick++")
include_directories("Magick++/lib")
include_directories("wand")

file(READ "magick/magick_config.h.in" CONFIG_H)
string(REPLACE "#undef HasBZLIB" "#define HasBZLIB" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef HasHEIF" "#define HasHEIF" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef HasJBIG" "#define HasJBIG" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef HasJPEG" "#define HasJPEG" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef HasJXL" "#define HasJXL" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef HasLCMS" "#define HasLCMS" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef HasLZMA" "#define HasLZMA" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef HasPNG" "#define HasPNG" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef HasTIFF" "#define HasTIFF" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef HasTTF" "#define HasTTF" CONFIG_H "${CONFIG_H}")
# GraphicsMagick is setting it automatically
# string(REPLACE "#undef HAVE_FT2BUILD_H" "#define HAVE_FT2BUILD_H" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef HasWEBP" "#define HasWEBP" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef HasXML" "#define HasXML" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef HasZLIB" "#define HasZLIB" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef HasZSTD" "#define HasZSTD" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef QuantumDepth" "#define QuantumDepth 16" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef restrict" "#define restrict" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef size_t" "/* #undef size_t */" CONFIG_H "${CONFIG_H}")
if (WIN32)
string(REPLACE "#undef HasWINGDI32" "#define HasWINGDI32" CONFIG_H "${CONFIG_H}")
else ()
string(REPLACE "#undef HAVE_VSNPRINTF" "#define HAVE_VSNPRINTF" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef MagickLibSubdir" "#define MagickLibSubdir \"magick\"" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef MagickLibConfigSubDir" "#define MagickLibConfigSubDir \"magick/config\"" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef MagickShareConfigSubDir" "#define MagickShareConfigSubDir \"magick/config\"" CONFIG_H "${CONFIG_H}")
string(REPLACE "#undef HAVE_STDINT_H" "#define HAVE_STDINT_H" CONFIG_H "${CONFIG_H}")
endif ()
file(WRITE "magick/magick_config.h" "${CONFIG_H}")

file(READ "magick/magick_config_api.h.in" CONFIG_API_H)
string(REPLACE "#undef QuantumDepth" "#define QuantumDepth 16" CONFIG_API_H "${CONFIG_API_H}")
string(REPLACE "#undef size_t" "/* #undef size_t */" CONFIG_API_H "${CONFIG_API_H}")
file(WRITE "magick/magick_config_api.h" "${CONFIG_API_H}")

file(GLOB CODERS_FILES coders/*.c)
file(GLOB FILTERS_FILES filters/*.c)
file(GLOB MAGICK_FILES magick/*.c)
file(GLOB MAGICKXX_FILES Magick++/lib/*.cpp)
file(GLOB WAND_FILES wand/*.c)
add_library(graphicsmagick ${CODERS_FILES} ${FILTERS_FILES} ${MAGICK_FILES} ${MAGICKXX_FILES} ${WAND_FILES})

TARGET_LINK_LIBRARIES(graphicsmagick PRIVATE
    BZip2::BZip2
	PkgConfig::libheif
	JBIG::JBIG
	JBIG85::JBIG85
    JPEG::JPEG
	PkgConfig::Jxl PkgConfig::JxlThreads
	PkgConfig::Lcms2
	LibLZMA::LibLZMA
    PNG::PNG
    TIFF::TIFF
    Freetype::Freetype
	WebP::webp WebP::webpdemux WebP::libwebpmux WebP::webpdecoder
	LibXml2::LibXml2
    ZLIB::ZLIB
    zstd::libzstd_shared
)
target_include_directories(graphicsmagick PRIVATE INTERFACE $<INSTALL_INTERFACE:include>)
target_compile_definitions(graphicsmagick PRIVATE -DHAVE_CONFIG_H -DHAVE_LCMS2_H)

install(TARGETS graphicsmagick
    EXPORT graphicsmagick-targets
    RUNTIME DESTINATION bin
    ARCHIVE DESTINATION lib
    LIBRARY DESTINATION lib)

install(
    EXPORT graphicsmagick-targets
    FILE unofficial-graphicsmagick-targets.cmake
    NAMESPACE unofficial::graphicsmagick::
    DESTINATION share/unofficial-graphicsmagick
)

file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/unofficial-graphicsmagick-config.cmake "
include(CMakeFindDependencyMacro)
find_dependency(BZip2)
find_dependency(libheif)
find_dependency(JBIG)
find_dependency(JBIG85)
find_dependency(JPEG)
find_dependency(Jxl)
find_dependency(JxlThreads)
find_dependency(Lcms2)
find_dependency(LibLZMA)
find_dependency(PNG)
find_dependency(TIFF)
find_dependency(Freetype)
find_dependency(ZLIB)
find_dependency(WebP)

include(\${CMAKE_CURRENT_LIST_DIR}/unofficial-graphicsmagick-targets.cmake)
")
install(FILES ${CMAKE_CURRENT_BINARY_DIR}/unofficial-graphicsmagick-config.cmake DESTINATION share/unofficial-graphicsmagick)

option(INSTALL_HEADERS "Install development header files" ON)

if (INSTALL_HEADERS)
    install(FILES magick/alpha_composite.h DESTINATION include/magick)
    install(FILES magick/analyze.h DESTINATION include/magick)
    install(FILES magick/api.h DESTINATION include/magick)
    install(FILES magick/attribute.h DESTINATION include/magick)
    install(FILES magick/average.h DESTINATION include/magick)
    install(FILES magick/bit_stream.h DESTINATION include/magick)
    install(FILES magick/blob.h DESTINATION include/magick)
    install(FILES magick/cdl.h DESTINATION include/magick)
    install(FILES magick/channel.h DESTINATION include/magick)
    install(FILES magick/color.h DESTINATION include/magick)
    install(FILES magick/colormap.h DESTINATION include/magick)
    install(FILES magick/colorspace.h DESTINATION include/magick)
    install(FILES magick/color_lookup.h DESTINATION include/magick)
    install(FILES magick/command.h DESTINATION include/magick)
    install(FILES magick/common.h DESTINATION include/magick)
    install(FILES magick/compare.h DESTINATION include/magick)
    install(FILES magick/composite.h DESTINATION include/magick)
    install(FILES magick/compress.h DESTINATION include/magick)
    install(FILES magick/confirm_access.h DESTINATION include/magick)
    install(FILES magick/constitute.h DESTINATION include/magick)
    install(FILES magick/decorate.h DESTINATION include/magick)
    install(FILES magick/delegate.h DESTINATION include/magick)
    install(FILES magick/deprecate.h DESTINATION include/magick)
    install(FILES magick/describe.h DESTINATION include/magick)
    install(FILES magick/draw.h DESTINATION include/magick)
    install(FILES magick/effect.h DESTINATION include/magick)
    install(FILES magick/enhance.h DESTINATION include/magick)
    install(FILES magick/enum_strings.h DESTINATION include/magick)
    install(FILES magick/error.h DESTINATION include/magick)
    install(FILES magick/floats.h DESTINATION include/magick)
    install(FILES magick/forward.h DESTINATION include/magick)
    install(FILES magick/fx.h DESTINATION include/magick)
    install(FILES magick/gem.h DESTINATION include/magick)
    install(FILES magick/gradient.h DESTINATION include/magick)
    install(FILES magick/hclut.h DESTINATION include/magick)
    install(FILES magick/image.h DESTINATION include/magick)
    install(FILES magick/list.h DESTINATION include/magick)
    install(FILES magick/locale_c.h DESTINATION include/magick)
    install(FILES magick/log.h DESTINATION include/magick)
    install(FILES magick/magic.h DESTINATION include/magick)
    install(FILES magick/magick.h DESTINATION include/magick)
    install(FILES magick/magick_config.h DESTINATION include/magick)
    install(FILES magick/magick_config_api.h DESTINATION include/magick)
    install(FILES magick/magick_endian.h DESTINATION include/magick)
    install(FILES magick/magick_types.h DESTINATION include/magick)
    install(FILES magick/map.h DESTINATION include/magick)
    install(FILES magick/memory.h DESTINATION include/magick)
    install(FILES magick/module.h DESTINATION include/magick)
    install(FILES magick/module_aliases.h DESTINATION include/magick)
    install(FILES magick/monitor.h DESTINATION include/magick)
    install(FILES magick/montage.h DESTINATION include/magick)
    install(FILES magick/nt_base.h DESTINATION include/magick)
    install(FILES magick/nt_feature.h DESTINATION include/magick)
    install(FILES magick/omp_data_view.h DESTINATION include/magick)
    install(FILES magick/operator.h DESTINATION include/magick)
    install(FILES magick/paint.h DESTINATION include/magick)
    install(FILES magick/pixel_cache.h DESTINATION include/magick)
    install(FILES magick/pixel_iterator.h DESTINATION include/magick)
    install(FILES magick/plasma.h DESTINATION include/magick)
    install(FILES magick/prefetch.h DESTINATION include/magick)
    install(FILES magick/PreRvIcccm.h DESTINATION include/magick)
    install(FILES magick/profile.h DESTINATION include/magick)
    install(FILES magick/quantize.h DESTINATION include/magick)
    install(FILES magick/random-private.h DESTINATION include/magick)
    install(FILES magick/random.h DESTINATION include/magick)
    install(FILES magick/registry.h DESTINATION include/magick)
    install(FILES magick/render.h DESTINATION include/magick)
    install(FILES magick/resize.h DESTINATION include/magick)
    install(FILES magick/resource.h DESTINATION include/magick)
    install(FILES magick/semaphore.h DESTINATION include/magick)
    install(FILES magick/shear.h DESTINATION include/magick)
    install(FILES magick/signature.h DESTINATION include/magick)
    install(FILES magick/spinlock.h DESTINATION include/magick)
    install(FILES magick/static.h DESTINATION include/magick)
    install(FILES magick/statistics.h DESTINATION include/magick)
    install(FILES magick/studio.h DESTINATION include/magick)
    install(FILES magick/symbols.h DESTINATION include/magick)
    install(FILES magick/tempfile.h DESTINATION include/magick)
    install(FILES magick/texture.h DESTINATION include/magick)
    install(FILES magick/timer.h DESTINATION include/magick)
    install(FILES magick/transform.h DESTINATION include/magick)
    install(FILES magick/tsd.h DESTINATION include/magick)
    install(FILES magick/type.h DESTINATION include/magick)
    install(FILES magick/unix_port.h DESTINATION include/magick)
    install(FILES magick/utility.h DESTINATION include/magick)
    install(FILES magick/version.h DESTINATION include/magick)
    install(FILES magick/widget.h DESTINATION include/magick)
    install(FILES magick/xwindow.h DESTINATION include/magick)

    install(FILES Magick++/lib/Magick++.h DESTINATION include)

    install(FILES Magick++/lib/Magick++/Blob.h DESTINATION include/Magick++)
    install(FILES Magick++/lib/Magick++/BlobRef.h DESTINATION include/Magick++)
    install(FILES Magick++/lib/Magick++/CoderInfo.h DESTINATION include/Magick++)
    install(FILES Magick++/lib/Magick++/Color.h DESTINATION include/Magick++)
    install(FILES Magick++/lib/Magick++/Drawable.h DESTINATION include/Magick++)
    install(FILES Magick++/lib/Magick++/Exception.h DESTINATION include/Magick++)
    install(FILES Magick++/lib/Magick++/Functions.h DESTINATION include/Magick++)
    install(FILES Magick++/lib/Magick++/Geometry.h DESTINATION include/Magick++)
    install(FILES Magick++/lib/Magick++/Image.h DESTINATION include/Magick++/)
    install(FILES Magick++/lib/Magick++/ImageRef.h DESTINATION include/Magick++)
    install(FILES Magick++/lib/Magick++/Include.h DESTINATION include/Magick++)
    install(FILES Magick++/lib/Magick++/Montage.h DESTINATION include/Magick++)
    install(FILES Magick++/lib/Magick++/Options.h DESTINATION include/Magick++)
    install(FILES Magick++/lib/Magick++/Pixels.h DESTINATION include/Magick++)
    install(FILES Magick++/lib/Magick++/STL.h DESTINATION include/Magick++)
    install(FILES Magick++/lib/Magick++/Thread.h DESTINATION include/Magick++)
    install(FILES Magick++/lib/Magick++/TypeMetric.h DESTINATION include/Magick++)

    install(FILES wand/drawing_wand.h DESTINATION include/wand)
    install(FILES wand/magick_wand.h DESTINATION include/wand)
    install(FILES wand/pixel_wand.h DESTINATION include/wand)
    install(FILES wand/wand_api.h DESTINATION include/wand)
    install(FILES wand/wand_private.h DESTINATION include/wand)
    install(FILES wand/wand_symbols.h DESTINATION include/wand)
endif ()
